name: Release

on:
  push:
    tags:
      - 'v*'  # ÂΩìÊé®ÈÄÅ v* Ê†áÁ≠æÊó∂Ëß¶Âèë

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤ÔºåÁî®‰∫éËØªÂèñ tag Ê≥®Èáä
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Get version and changelog
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
        # ‰ªé tag Ê≥®Èáä‰∏≠ÊèêÂèñ changelog
        CHANGELOG=$(git tag -l --format='%(contents)' "v$VERSION" | tail -n +3)
        
        # Â¶ÇÊûú changelog ‰∏∫Á©∫Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄº
        if [ -z "$CHANGELOG" ]; then
          CHANGELOG="Release version $VERSION"
        fi
        
        # Â∞Ü changelog ‰øùÂ≠òÂà∞Êñá‰ª∂ÔºàÂ§ÑÁêÜÂ§öË°åÔºâ
        echo "$CHANGELOG" > /tmp/changelog.txt
        echo "Changelog extracted"
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --configuration Release --no-restore
      
    - name: Verify DLL exists
      run: |
        if [ ! -f "bin/Release/net8.0/JellyfinAppleLyrics.dll" ]; then
          echo "Error: DLL file not found!"
          exit 1
        fi
        echo "DLL found: $(ls -lh bin/Release/net8.0/JellyfinAppleLyrics.dll)"
      
    - name: Create package
      run: |
        mkdir -p releases
        cd bin/Release/net8.0
        zip -j ../../../releases/JellyfinAppleLyrics.dll.zip JellyfinAppleLyrics.dll
        cd ../../..
        echo "Package created: $(ls -lh releases/JellyfinAppleLyrics.dll.zip)"
        
    - name: Calculate checksum
      id: checksum
      run: |
        CHECKSUM=$(md5sum releases/JellyfinAppleLyrics.dll.zip | awk '{print $1}')
        echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
        echo "MD5 Checksum: $CHECKSUM"
        
    - name: Update manifest.json
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        CHECKSUM="${{ steps.checksum.outputs.checksum }}"
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        SOURCE_URL="https://github.com/SnowSwordScholar/JellyfinAppleMusicLikeLyrics/releases/download/v${VERSION}/JellyfinAppleLyrics.dll.zip"
        
        # ËØªÂèñ changelog
        CHANGELOG=$(cat /tmp/changelog.txt | jq -Rs .)
        
        # ÂàõÂª∫Êñ∞ÁâàÊú¨ JSON
        NEW_VERSION=$(jq -n \
          --arg version "${VERSION}.0" \
          --argjson changelog "$CHANGELOG" \
          --arg targetAbi "10.10.0.0" \
          --arg sourceUrl "$SOURCE_URL" \
          --arg checksum "$CHECKSUM" \
          --arg timestamp "$TIMESTAMP" \
          '{
            version: $version,
            changelog: $changelog,
            targetAbi: $targetAbi,
            sourceUrl: $sourceUrl,
            checksum: $checksum,
            timestamp: $timestamp
          }')
        
        # Êõ¥Êñ∞ manifest.json
        jq --argjson newver "$NEW_VERSION" \
           '.[0].versions = ([$newver] + (.[0].versions | map(select(.version != $newver.version))))' \
           manifest.json > manifest.json.tmp
        
        mv manifest.json.tmp manifest.json
        
        echo "Manifest updated successfully"
        cat manifest.json
        
    - name: Extract changelog for release body
      id: changelog
      run: |
        CHANGELOG=$(cat /tmp/changelog.txt)
        echo "content<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Commit and push manifest
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add manifest.json
        
        if git diff --staged --quiet; then
          echo "No changes to manifest.json"
        else
          git commit -m "chore: update manifest.json for v${{ steps.version.outputs.version }}"
          git push origin HEAD:main
          echo "Manifest pushed to main branch"
        fi
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: releases/JellyfinAppleLyrics.dll.zip
        body: |
          ## üéµ Release ${{ steps.version.outputs.version }}
          
          ### üìù Changelog
          
          ${{ steps.changelog.outputs.content }}
          
          ### üì¶ Installation
          
          **Option 1: Direct Download**
          1. Download `JellyfinAppleLyrics.dll.zip`
          2. Extract to your Jellyfin plugins folder
          3. Restart Jellyfin server
          4. Enable the plugin in Jellyfin Dashboard
          
          **Option 2: Repository Installation**
          1. Go to Jellyfin Dashboard ‚Üí Plugins ‚Üí Repositories
          2. Add repository: `https://raw.githubusercontent.com/SnowSwordScholar/JellyfinAppleMusicLikeLyrics/main/manifest.json`
          3. Install "Apple Music Like Lyrics" from the Catalog
          
          ### üîê Checksum
          
          **MD5:** `${{ steps.checksum.outputs.checksum }}`
          
          ### üîó Links
          
          - [Repository](https://github.com/SnowSwordScholar/JellyfinAppleMusicLikeLyrics)
          - [Issues](https://github.com/SnowSwordScholar/JellyfinAppleMusicLikeLyrics/issues)
          - [Manifest](https://github.com/SnowSwordScholar/JellyfinAppleMusicLikeLyrics/blob/main/manifest.json)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
